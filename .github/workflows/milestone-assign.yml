name: Auto-assign Milestones

on:
  pull_request:
    types: [opened, labeled, synchronize]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Assign milestone based on label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            let milestoneTitle = null;

            if (labels.includes('m0')) milestoneTitle = 'M0 – Bootstrap';
            if (labels.includes('m1')) milestoneTitle = 'M1 – Auth & Provider Onboarding';
            if (labels.includes('m2')) milestoneTitle = 'M2 – Categories, Services, Discovery';
            if (labels.includes('m3')) milestoneTitle = 'M3 – Real-Time Availability & Jobs';
            if (labels.includes('m4')) milestoneTitle = 'M4 – Quotes, Assignment, Tracking';
            if (labels.includes('m5')) milestoneTitle = 'M5 – Payments & Reviews';
            if (labels.includes('m6')) milestoneTitle = 'M6 – LLM, STT & RAG';
            if (labels.includes('m7')) milestoneTitle = 'M7 – Hardening & Beta';

            if (milestoneTitle) {
              const { data: milestones } = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open"
              });

              const milestone = milestones.find(m => m.title === milestoneTitle);
              if (milestone) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  milestone: milestone.number
                });
                core.info(`✅ Assigned milestone '${milestoneTitle}' to PR #${context.payload.pull_request.number}`);
              }
            }
