name: Project Automation

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

on:
  workflow_dispatch: {}
  issues:
    types: [opened, labeled, reopened, closed]
  pull_request:
    types: [opened, labeled, reopened, synchronize, closed]

jobs:
  debug-token:
    runs-on: ubuntu-latest
    steps:
      - name: Debug GitHub token permissions
        run: |
          echo "ðŸ”Ž Checking token scopes..."
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/rate_limit
          echo "âœ… If this call succeeds, the token is valid."
          echo "ðŸ”Ž Checking repo permissions from GitHub context..."
          echo '${{ toJson(github.permissions) }}'

  auto-label:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
    steps:
      - name: Auto-apply milestone labels
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            ${{ startsWith(env.BRANCH_NAME, 'm0') || contains(env.BRANCH_NAME, 'bootstrap') && 'm0' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm1') || contains(env.BRANCH_NAME, 'auth') && 'm1' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm2') || contains(env.BRANCH_NAME, 'categories') && 'm2' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm3') || contains(env.BRANCH_NAME, 'availability') && 'm3' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm4') || contains(env.BRANCH_NAME, 'quotes') && 'm4' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm5') || contains(env.BRANCH_NAME, 'payments') && 'm5' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm6') || contains(env.BRANCH_NAME, 'llm') && 'm6' || '' }}
            ${{ startsWith(env.BRANCH_NAME, 'm7') || contains(env.BRANCH_NAME, 'beta') && 'm7' || '' }}

  add-to-project:
    runs-on: ubuntu-latest
    needs: debug-token
    steps:
      - name: Add item to Project Board
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/${{ github.repository_owner }}/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}
          labeled: m0,m1,m2,m3,m4,m5,m6,m7
